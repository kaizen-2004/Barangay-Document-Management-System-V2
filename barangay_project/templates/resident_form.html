{% extends 'base.html' %}
{% block content %}
<h2>{{ title or 'Resident Form' }}</h2>
<form method="POST">
    {{ form.hidden_tag() }}
    {{ form.photo_data(id='photo_data') }}

    <div class="mb-3">
        <label class="form-label">Resident Photo (In-app Camera)</label>
        <div class="card p-3">
            <div class="d-flex flex-wrap gap-3 align-items-start">
                <div>
                    <video id="cam_video" autoplay playsinline class="border rounded" style="width: 320px; max-width: 100%;"></video>
                    <canvas id="cam_canvas" class="d-none"></canvas>
                    <div class="mt-2 d-flex gap-2">
                        <button type="button" id="btn_start" class="btn btn-outline-primary btn-sm">Start Camera</button>
                        <button type="button" id="btn_capture" class="btn btn-primary btn-sm" disabled>Capture</button>
                        <button type="button" id="btn_clear" class="btn btn-outline-secondary btn-sm" disabled>Clear</button>
                    </div>
                    <div class="form-text mt-2">Use the webcam to capture a photo inside the system. The captured image is saved locally on the server.</div>
                </div>

                <div>
                    <div class="fw-semibold mb-1">Preview</div>
                    <img id="photo_preview" alt="Captured preview" class="border rounded" style="width: 320px; max-width: 100%; min-height: 240px; object-fit: cover;" />
                    <div class="form-text mt-2">If you donâ€™t see the camera, allow browser permissions.</div>
                </div>
            </div>

            {# No file upload: photo is captured in-app via the webcam #}
        </div>
    </div>
<div class="form-group">
        {{ form.barangay_id.label(class="form-label") }}
        {{ form.barangay_id(class="form-control", placeholder="(Optional) Leave blank to auto-generate") }}
        <div class="form-text">If left blank, the system will auto-generate a Barangay ID after saving.</div>
        {% for error in form.barangay_id.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>
    <div class="form-group">
        {{ form.first_name.label(class="form-label") }}
        {{ form.first_name(class="form-control") }}
        {% for error in form.first_name.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>
    <div class="form-group">
        {{ form.middle_name.label(class="form-label") }}
        {{ form.middle_name(class="form-control") }}
        {% for error in form.middle_name.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>
    <div class="form-group">
        {{ form.last_name.label(class="form-label") }}
        {{ form.last_name(class="form-control") }}
        {% for error in form.last_name.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>
    <div class="form-group">
        {{ form.gender.label(class="form-label") }}
        {{ form.gender(class="form-control") }}
        {% for error in form.gender.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>
    <div class="form-group">
        {{ form.birth_date.label(class="form-label") }}
        {{ form.birth_date(class="form-control", type="date") }}
        {% for error in form.birth_date.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>
    <div class="form-group">
        {{ form.marital_status.label(class="form-label") }}
        {{ form.marital_status(class="form-control") }}
        {% for error in form.marital_status.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>
    <div class="form-group">
        {{ form.address.label(class="form-label") }}
        {{ form.address(class="form-control") }}
        {% for error in form.address.errors %}
            <div class="text-danger small">{{ error }}</div>
        {% endfor %}
    </div>
    <button type="submit" class="btn btn-primary">{{ form.submit.label.text }}</button>
</form>

<script>
(() => {
  const video = document.getElementById('cam_video');
  const canvas = document.getElementById('cam_canvas');
  const preview = document.getElementById('photo_preview');
  const photoData = document.getElementById('photo_data');

  const btnStart = document.getElementById('btn_start');
  const btnCapture = document.getElementById('btn_capture');
  const btnClear = document.getElementById('btn_clear');

  let stream = null;

  async function startCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      video.srcObject = stream;
      btnCapture.disabled = false;
      btnStart.disabled = true;
    } catch (err) {
      console.error(err);
      alert('Unable to access camera. Please allow camera permission in your browser.');
    }
  }

  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    video.srcObject = null;
    btnCapture.disabled = true;
    btnStart.disabled = false;
  }

  function capture() {
    if (!video.videoWidth || !video.videoHeight) return;
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Use JPEG to keep file sizes manageable
    const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
    photoData.value = dataUrl;
    preview.src = dataUrl;
    btnClear.disabled = false;
  }

  function clearCapture() {
    photoData.value = '';
    preview.removeAttribute('src');
    btnClear.disabled = true;
  }

  btnStart?.addEventListener('click', startCamera);
  btnCapture?.addEventListener('click', capture);
  btnClear?.addEventListener('click', clearCapture);

  // If the form already has a value (e.g., validation failed), keep preview
  if (photoData?.value) preview.src = photoData.value;

  // Stop camera on page unload
  window.addEventListener('beforeunload', stopCamera);
})();
</script>
{% endblock %}
